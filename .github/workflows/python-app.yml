name: Python App CI/CD

on:
  push:
    branches:
      - parking/cleaver
  pull_request:
    branches:
      - parking/cleaver

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies for linters
        run: |
          python -m pip install --upgrade pip
          pip install flake8 isort ruff

      - name: Run linters and formatters
        run: |
          # Проверка и исправление кода
          flake8 .
          isort --recursive .
          ruff check --fix .

      - name: Install Docker and Compose
        uses: docker/setup-buildx-action@v2
        with:
          driver: 'docker'
        id: docker

      - name: Login to Docker Hub (if needed)
        uses: docker/login-action@v2
        with:
              registry: docker.io
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and start containers with Docker Compose
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          docker compose build --no-cache
          docker compose up -d

      - name: Run tests
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          TESTING: "True"
        run: |
          # Запуск тестов, например, используя pytest
          docker-compose exec web pytest tests/

      - name: Stop and remove containers
        run: |
          docker-compose down -v
